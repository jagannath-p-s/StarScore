-- Clients table remains the same
CREATE TABLE public.clients (
    id serial PRIMARY KEY,
    useremail VARCHAR(255) UNIQUE NOT NULL,
    reviewurl TEXT,
    extractionurl TEXT,
    logourl TEXT,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
) TABLESPACE pg_default;

-- Modify salesmen table to include client_id and created_at timestamp
CREATE TABLE public.salesmen (
    id serial PRIMARY KEY,
    name text NOT NULL,
    points integer DEFAULT 0,
    client_id integer REFERENCES clients(id),
    created_at TIMESTAMP DEFAULT NOW()
) TABLESPACE pg_default;


-- Create a new table to store client_id, salesman_id, and a timestamp
CREATE TABLE public.client_salesman_activity (
    id serial PRIMARY KEY,
    client_id integer REFERENCES clients(id),
    salesman_id integer REFERENCES salesmen(id),
    activity_timestamp TIMESTAMP DEFAULT NOW()
) TABLESPACE pg_default;



-- Modify review_counts table to associate with a specific client_id
CREATE TABLE public.review_counts (
    id serial PRIMARY KEY,
    count integer,
    client_id integer REFERENCES clients(id)
) TABLESPACE pg_default;


CREATE OR REPLACE FUNCTION update_salesman_points()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE public.salesmen
    SET points = points + 1
    WHERE id = NEW.salesman_id;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;


CREATE TRIGGER update_salesman_points_trigger
AFTER INSERT ON public.client_salesman_activity
FOR EACH ROW
EXECUTE FUNCTION update_salesman_points();





INSERT INTO public.clients (id, useremail, reviewurl, extractionurl, logourl, password, created_at)
VALUES (
    2, 
    'whitedog@example.com', 
    'https://search.google.com/local/writereview?placeid=ChIJEUxg2ZLvpzsRZAYNK_VEU5Y', 
    'https://www.google.com/search?q=white+dog+thrissur&sca_esv=5e03de341bb9f1d9&ei=TJFdZoOkNL6eseMPtPiuiAI&oq=whitedog+thrissur&gs_lp=Egxnd3Mtd2l6LXNlcnAiEXdoaXRlZG9nIHRocmlzc3VyKgIIADIKEAAYgAQYsAMYDTIKEAAYgAQYsAMYDTILEAAYsAMYCBgNGB4yDhAAGIAEGLADGIYDGIoFMgsQABiABBiwAxiiBEihElAAWABwAXgAkAEAmAEAoAEAqgEAuAEByAEAmAIBoAIQmAMAiAYBkAYFkgcBMaAHAA&sclient=gws-wiz-serp', 
    'https://ldkbzfcoewzynxawicxg.supabase.co/storage/v1/object/sign/whitetap/whitedog.png?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1cmwiOiJ3aGl0ZXRhcC93aGl0ZWRvZy5wbmciLCJpYXQiOjE3MTc0MDkyODMsImV4cCI6MTc4MDQ4MTI4M30.iQySHP_8WbYot_UECdN897dNo0D2xhFHQudEX-McTr8&t=2024-06-03T10%3A08%3A03.207Z', 
    'password', 
    '2024-06-03 09:05:37.139777'
);



INSERT INTO public.salesmen (name, points, client_id, created_at)
VALUES (
    'John Doe', 
    0, 
    1,  -- Assuming this is linked to the client with id 1
    NOW()
);




INSERT INTO public.review_counts (count, client_id)
VALUES (
    0,   -- Initial review count is zero
    1    -- Associating with client_id 1
);






SUPABASE_URL = "https://ldkbzfcoewzynxawicxg.supabase.co"
SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxka2J6ZmNvZXd6eW54YXdpY3hnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTU4NjQwMDQsImV4cCI6MjAzMTQ0MDAwNH0.sE_JK5ZbobAOzWKR6osasEVfZPWhVt08NhRf0XgrsmA"


